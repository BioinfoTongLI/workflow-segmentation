docker.enabled = false

singularity {
  enabled = true
  autoMounts = true
  runOptions = "--containall"
  cacheDir = '/lustre/scratch126/cellgen/team283/NXF_WORK'
}

// Executor details
executor{
    name = 'lsf'
    perJobMemLimit = true
    poolSize = 4
    submitRateLimit = '5 sec'
    killBatchSize = 50
}

process {
  executor = 'lsf'
  queue = { task.time < 12.h ? 'normal' : task.time < 48.h ? 'long' : task.time < 168.h ? 'week' : 'basement' }
  errorStrategy = { task.exitStatus in [130,137..140] ? 'retry' : 'terminate' }
  maxRetries = 5

  withLabel: gpu {
      queue = { task.time > 12.h ? 'gpu-basement' : task.memory > 80.GB ? 'gpu-huge' : 'gpu-normal' } // GPU memory is not monitored -> use taks.memory as a guess of GPU memory requirement
      clusterOptions = {" -gpu \"mode=shared:j_exclusive=no:num=1\""} // again GPU memory is not monitored -> allocate whatever left on the machine
  }
  withName : stitch {
    cpus = { 1 * task.attempt }
    memory = { 100.GB * task.attempt }
  }

  withName : slice {
    cpus = { 1 * task.attempt }
    memory = { 100.GB * task.attempt }
  }

  withName : cellpose_cell_segmentation_batch {
    cpus = { 10 * task.attempt }
    memory = { 60.GB * task.attempt }
    queue = "gpu-normal"

    maxForks = 10
    clusterOptions = {" -gpu \"mode=shared:j_exclusive=no:gmem=12000:num=1\""}
  }

  withName : expand_label_image {
    cpus = { 1 * task.attempt }
    memory = { 200.GB * task.attempt }
  }

  withLabel: gpu_normal {
    cpus = { 4 * task.attempt }
    memory = { 50.GB * task.attempt }
    queue = "gpu-normal"
    clusterOptions = {" -gpu \"mode=shared:j_exclusive=no:gmem=6000:num=1\""}
  }

  withLabel: cpu_only {
    cpus = { 20 * task.attempt }
    memory = { 60.GB * task.attempt }
  }
}
